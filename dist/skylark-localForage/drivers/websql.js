/**
 * skylark-localForage - A skylark wrapper for localForage.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/isWebSQLValid","../utils/serializer","../utils/promise","../utils/executeCallback","../utils/normalizeKey","../utils/getCallback"],function(n,t,e,i,o,r){"use strict";function a(n,t,e,i){n.executeSql(`CREATE TABLE IF NOT EXISTS ${t.storeName} `+"(id INTEGER PRIMARY KEY, key unique, value)",[],e,i)}function c(n,t,e,i,o,r){n.executeSql(e,i,o,function(n,c){c.code===c.SYNTAX_ERR?n.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],function(n,u){u.rows.length?r(n,c):a(n,t,function(){n.executeSql(e,i,o,r)},r)},r):r(n,c)},r)}return{_driver:"webSQLStorage",_initStorage:function(n){var i=this,o={db:null};if(n)for(var r in n)o[r]="string"!=typeof n[r]?n[r].toString():n[r];var c=new e(function(n,t){try{o.db=openDatabase(o.name,String(o.version),o.description,o.size)}catch(n){return t(n)}o.db.transaction(function(e){a(e,o,function(){i._dbInfo=o,n()},function(n,e){t(e)})},t)});return o.serializer=t,c},_support:n(),iterate:function(n,t){var o=this,r=new e(function(t,e){o.ready().then(function(){var i=o._dbInfo;i.db.transaction(function(o){c(o,i,`SELECT * FROM ${i.storeName}`,[],function(e,o){for(var r=o.rows,a=r.length,c=0;c<a;c++){var u=r.item(c),f=u.value;if(f&&(f=i.serializer.deserialize(f)),void 0!==(f=n(f,u.key,c+1)))return void t(f)}t()},function(n,t){e(t)})})}).catch(e)});return i(r,t),r},getItem:function(n,t){var r=this;n=o(n);var a=new e(function(t,e){r.ready().then(function(){var i=r._dbInfo;i.db.transaction(function(o){c(o,i,`SELECT * FROM ${i.storeName} WHERE key = ? LIMIT 1`,[n],function(n,e){var o=e.rows.length?e.rows.item(0).value:null;o&&(o=i.serializer.deserialize(o)),t(o)},function(n,t){e(t)})})}).catch(e)});return i(a,t),a},setItem:function(n,t,r){return function n(t,r,a,u){var f=this;t=o(t);var s=new e(function(e,i){f.ready().then(function(){void 0===r&&(r=null);var o=r,s=f._dbInfo;s.serializer.serialize(r,function(r,l){l?i(l):s.db.transaction(function(n){c(n,s,`INSERT OR REPLACE INTO ${s.storeName} `+"(key, value) VALUES (?, ?)",[t,r],function(){e(o)},function(n,t){i(t)})},function(r){if(r.code===r.QUOTA_ERR){if(u>0)return void e(n.apply(f,[t,o,a,u-1]));i(r)}})})}).catch(i)});return i(s,a),s}.apply(this,[n,t,r,1])},removeItem:function(n,t){var r=this;n=o(n);var a=new e(function(t,e){r.ready().then(function(){var i=r._dbInfo;i.db.transaction(function(o){c(o,i,`DELETE FROM ${i.storeName} WHERE key = ?`,[n],function(){t()},function(n,t){e(t)})})}).catch(e)});return i(a,t),a},clear:function(n){var t=this,o=new e(function(n,e){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){c(t,i,`DELETE FROM ${i.storeName}`,[],function(){n()},function(n,t){e(t)})})}).catch(e)});return i(o,n),o},length:function(n){var t=this,o=new e(function(n,e){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){c(t,i,`SELECT COUNT(key) as c FROM ${i.storeName}`,[],function(t,e){var i=e.rows.item(0).c;n(i)},function(n,t){e(t)})})}).catch(e)});return i(o,n),o},key:function(n,t){var o=this,r=new e(function(t,e){o.ready().then(function(){var i=o._dbInfo;i.db.transaction(function(o){c(o,i,`SELECT key FROM ${i.storeName} WHERE id = ? LIMIT 1`,[n+1],function(n,e){var i=e.rows.length?e.rows.item(0).key:null;t(i)},function(n,t){e(t)})})}).catch(e)});return i(r,t),r},keys:function(n){var t=this,o=new e(function(n,e){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){c(t,i,`SELECT key FROM ${i.storeName}`,[],function(t,e){for(var i=[],o=0;o<e.rows.length;o++)i.push(e.rows.item(o).key);n(i)},function(n,t){e(t)})})}).catch(e)});return i(o,n),o},dropInstance:function(n,t){t=r.apply(this,arguments);var o=this.config();(n="function"!=typeof n&&n||{}).name||(n.name=n.name||o.name,n.storeName=n.storeName||o.storeName);var a,c=this;return a=n.name?new e(function(t){var i;i=n.name===o.name?c._dbInfo.db:openDatabase(n.name,"","",0),n.storeName?t({db:i,storeNames:[n.storeName]}):t(function(n){return new e(function(t,e){n.transaction(function(i){i.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(e,i){for(var o=[],r=0;r<i.rows.length;r++)o.push(i.rows.item(r).name);t({db:n,storeNames:o})},function(n,t){e(t)})},function(n){e(n)})})}(i))}).then(function(n){return new e(function(t,i){n.db.transaction(function(o){function r(n){return new e(function(t,e){o.executeSql(`DROP TABLE IF EXISTS ${n}`,[],function(){t()},function(n,t){e(t)})})}for(var a=[],c=0,u=n.storeNames.length;c<u;c++)a.push(r(n.storeNames[c]));e.all(a).then(function(){t()}).catch(function(n){i(n)})},function(n){i(n)})})}):e.reject("Invalid arguments"),i(a,t),a}}});
//# sourceMappingURL=../sourcemaps/drivers/websql.js.map
